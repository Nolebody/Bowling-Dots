<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bowling Dots — Tap Counter (PWA v7)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a0a0a">
<style>
  :root { color-scheme: dark; }
  html, body { margin:0; padding:0; background:#0a0a0a; color:#e5e5e5; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 24px; margin: 0 0 4px 0; }
  .muted { color:#a3a3a3; font-size: 14px; }
  .toolbar { display:flex; flex-wrap: wrap; gap:8px; align-items:center; margin-top: 8px; }
  input[type="text"], input[type="number"] { background:#1a1a1a; border:1px solid #333; color:#e5e5e5; border-radius:10px; padding:8px 10px; }
  button { background:#1f2937; color:#e5e5e5; border:1px solid #334155; border-radius:10px; padding:8px 12px; cursor:pointer; }
  button:hover { background:#334155; }
  .btn-primary { background:#047857; border-color:#065f46; }
  .btn-primary:hover { background:#059669; }
  .btn-danger { border-color:#b91c1c; color:#fca5a5; }
  .btn-tab { background:#111827; border-color:#374151; }
  .btn-tab.active { background:#374151; }
  .card { background:#0f0f0f; border:1px solid #262626; border-radius:16px; padding:16px; margin-top:16px; }
  .grid { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:8px; }
  .rate { display:flex; justify-content:space-between; align-items:center; background:#121212; border:1px solid #262626; border-radius:12px; padding:8px 10px; font-size:14px; }
  .table-wrap { position: relative; overflow: auto; }
  table { width:100%; border-collapse:collapse; min-width:980px; }
  th, td { padding:8px; border-top:1px solid #262626; vertical-align:top; background:#0f0f0f; }
  th { color:#cfcfcf; text-align:left; }
  thead th { position: sticky; top: 0; z-index: 5; background:#0f0f0f; }
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .center { text-align:center; }
  .counter { display:flex; gap:8px; align-items:center; justify-content:center; }
  .counter button { width:32px; height:32px; border-radius:8px; }
  .counter .plus { background:#166534; }
  .counter .plus:hover { background:#22c55e; }
  .small { font-size:11px; color:#a3a3a3; text-align:center; margin-top:4px; }
  tfoot td { font-weight:600; }
  .nowrap { white-space: nowrap; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex: 1 1 auto; }
  details summary { cursor: pointer; }
  .sticky-col { position: sticky; left: 0; z-index: 3; box-shadow: 2px 0 0 #262626; }
  .sticky-header { position: sticky; left: 0; z-index: 6; box-shadow: 2px 0 0 #262626; background:#0f0f0f; }
  .sticky-footer { position: sticky; left: 0; z-index: 2; box-shadow: 2px 0 0 #262626; }
  .version { font-size:12px; color:#a3a3a3; }
  .error { background:#7f1d1d; color:#fecaca; padding:8px 12px; border-radius:10px; margin-top:10px; display:none; }
  @media (max-width: 1200px) { .container { padding: 16px; } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex; align-items:flex-end; gap:12px;">
        <h1 style="margin:0;">Bowling Dots — Tap Counter</h1>
        <span class="version">v7</span>
      </div>
      <div class="muted">5‑man team • plus/minus taps • offline PWA • Archive • <b>Totals</b></div>
      <div class="toolbar">
        <button id="tabLive" class="btn-tab active">Live</button>
        <button id="tabTotals" class="btn-tab">Totals</button>
        <span class="spacer"></span>
        <span id="installHint" class="muted"></span>
      </div>
      <div id="errorBar" class="error"></div>
    </header>

    <section id="liveSection">
      <div class="toolbar" style="margin-top:10px;">
        <input id="titleInput" type="text" size="28" />
        <button id="saveNightBtn" class="btn-primary">Save Night</button>
        <button id="exportBtn">Export This Night (CSV)</button>
        <button id="resetCountersBtn">Reset Counters</button>
        <button id="resetAllBtn" class="btn-danger">Reset All</button>
      </div>

      <section class="card">
        <div class="row">
          <h3 style="margin:0;">Category Rates</h3>
          <span class="spacer"></span>
          <small class="muted">Tap +/− to adjust counters. Enter Paid to see balances.</small>
        </div>
        <div id="rates" class="grid"></div>
      </section>

      <section class="card table-wrap">
        <table id="table">
          <thead>
            <tr id="tableHeader">
              <th class="sticky-header">Bowler</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
          <tfoot>
            <tr id="tableFooter">
              <td class="sticky-footer">Team Total</td>
            </tr>
          </tfoot>
        </table>
      </section>

      <section class="card">
        <div class="row">
          <h3 style="margin:0;">Archive</h3>
          <span class="spacer"></span>
          <button id="exportAllBtn">Export All (CSV)</button>
          <button id="clearArchiveBtn" class="btn-danger">Clear Archive</button>
        </div>
        <div id="archiveList" style="margin-top:8px;"></div>
      </section>
    </section>

    <section id="totalsSection" style="display:none;">
      <section class="card">
        <div class="row">
          <h3 style="margin:0;">Season Totals</h3>
          <span class="spacer"></span>
          <label class="muted"><input type="checkbox" id="includeLiveChk" checked style="margin-right:6px;">Include current night</label>
        </div>
        <div id="totalsByBowler" class="table-wrap"></div>
      </section>

      <section class="card">
        <h3 style="margin:0;">Team Totals by Category</h3>
        <div id="totalsByCategory" class="table-wrap" style="margin-top:8px;"></div>
      </section>

      <section class="card">
        <h3 style="margin:0;">Nights Summary</h3>
        <div id="totalsByNight" class="table-wrap" style="margin-top:8px;"></div>
      </section>
    </section>

    <section style="font-size:12px; color:#a3a3a3; margin-top:8px;">
      <p>• Install as a PWA: open this page, <b>Add to Home Screen</b> (iOS: Safari Share → Add to Home Screen; Android: Chrome menu → Install App).</p>
      <p>• Works offline after the first load. If the bowling alley Wi‑Fi is spotty, you’re covered.</p>
    </section>
  </div>

<script>
(function(){
  function showError(msg){
    const bar = document.getElementById("errorBar");
    bar.textContent = "Error: " + msg;
    bar.style.display = "block";
  }

  try { main(); } catch (e) { console.error(e); showError(e.message || String(e)); }

  function main(){
    const DEFAULT_BOWLERS = ["Beau", "Doug", "Gerod", "Chris", "Logan"];
    const CATEGORIES = [
      { key: "missedSpare", label: "Missed Spare", value: 0.10 },
      { key: "missedHeadpin", label: "Missed Headpin", value: 0.10 },
      { key: "coke", label: "Coke (all but you strike)", value: 0.50 },
      { key: "threeInARow", label: "3 in a Row (Turkey)", value: 0.10 },
      { key: "reverseCoke", label: "Reverse Coke (only you strike)", value: 0.25 },
      { key: "buddy", label: "Buddy (prevent Coke)", value: 0.25 },
      { key: "average", label: "Average (didn’t beat avg)", value: 1.00 },
      { key: "loss", label: "Loss (H2H)", value: 1.00 }
    ];
    const STORAGE_KEY = "dotsSession_pwa_v7";
    const ARCHIVE_KEY = "dotsArchive_v1";

    function currency(n){ return "$" + n.toFixed(2); }
    function sumSubtotal(b){ return CATEGORIES.reduce((acc,c)=>acc+(b.counts[c.key]||0)*c.value,0); }
    function csvEscape(cell){ return '"' + String(cell).replace(/"/g,'""') + '"'; }

    let state = loadState() || seedState();
    function seedState(){
      const d = new Date();
      const title = `Dots — ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      return { title, bowlers: DEFAULT_BOWLERS.map(n => ({ name:n, counts:Object.fromEntries(CATEGORIES.map(c=>[c.key,0])), paid:0 })) };
    }
    function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null; } }
    function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){} }
    function loadArchive(){ try{ return JSON.parse(localStorage.getItem(ARCHIVE_KEY)) || []; }catch(e){ return []; } }
    function saveArchive(a){ try{ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(a)); }catch(e){} }

    const tabLive = document.getElementById("tabLive");
    const tabTotals = document.getElementById("tabTotals");
    const liveSection = document.getElementById("liveSection");
    const totalsSection = document.getElementById("totalsSection");
    const includeLiveChk = document.getElementById("includeLiveChk");

    const titleInput = document.getElementById("titleInput");
    const ratesEl = document.getElementById("rates");
    const theadRow = document.getElementById("tableHeader");
    const tbody = document.getElementById("tableBody");
    const tfootRow = document.getElementById("tableFooter");
    const exportBtn = document.getElementById("exportBtn");
    const resetCountersBtn = document.getElementById("resetCountersBtn");
    const resetAllBtn = document.getElementById("resetAllBtn");
    const saveNightBtn = document.getElementById("saveNightBtn");
    const archiveList = document.getElementById("archiveList");
    const clearArchiveBtn = document.getElementById("clearArchiveBtn");
    const exportAllBtn = document.getElementById("exportAllBtn");
    const installHint = document.getElementById("installHint");

    tabLive.addEventListener("click", ()=>{ tabLive.classList.add("active"); tabTotals.classList.remove("active"); liveSection.style.display="block"; totalsSection.style.display="none"; });
    tabTotals.addEventListener("click", ()=>{ tabTotals.classList.add("active"); tabLive.classList.remove("active"); liveSection.style.display="none"; totalsSection.style.display="block"; renderTotals(); });
    includeLiveChk.addEventListener("change", renderTotals);

    function render(){
      titleInput.value = state.title;

      ratesEl.innerHTML = "";
      CATEGORIES.forEach(c=>{
        const div = document.createElement("div"); div.className="rate";
        const left = document.createElement("span"); left.textContent = c.label;
        const right = document.createElement("span"); right.textContent = currency(c.value);
        div.appendChild(left); div.appendChild(right); ratesEl.appendChild(div);
      });

      while (theadRow.children.length > 1) theadRow.removeChild(theadRow.lastChild);
      CATEGORIES.forEach(c=>{ const th=document.createElement("th"); th.textContent=c.label; th.className="center nowrap"; theadRow.appendChild(th); });
      ["Subtotal","Paid","Balance"].forEach(txt=>{ const th=document.createElement("th"); th.textContent=txt; th.className="num"; theadRow.appendChild(th); });

      tbody.innerHTML = "";
      state.bowlers.forEach(b=>{
        const tr=document.createElement("tr");

        const tdName=document.createElement("td"); tdName.className="sticky-col";
        const nameInput=document.createElement("input"); nameInput.type="text"; nameInput.value=b.name; nameInput.size=14;
        nameInput.addEventListener("input", ()=>{ b.name=nameInput.value; saveState(); });
        tdName.appendChild(nameInput); tr.appendChild(tdName);

        CATEGORIES.forEach(c=>{
          const td=document.createElement("td");
          const box=document.createElement("div"); box.className="counter";

          const minus=document.createElement("button"); minus.textContent="−";
          minus.addEventListener("click", ()=>{ b.counts[c.key] = Math.max(0,(b.counts[c.key]||0)-1); saveState(); render(); });

          const count=document.createElement("div"); count.textContent=b.counts[c.key]||0; count.style.width="40px"; count.style.textAlign="center"; count.style.fontVariantNumeric="tabular-nums";

          const plus=document.createElement("button"); plus.textContent="+"; plus.className="plus";
          plus.addEventListener("click", ()=>{ b.counts[c.key] = (b.counts[c.key]||0)+1; saveState(); render(); });

          box.appendChild(minus); box.appendChild(count); box.appendChild(plus);
          td.appendChild(box);

          const small=document.createElement("div"); small.className="small"; small.textContent=currency((b.counts[c.key]||0)*c.value);
          td.appendChild(small);
          tr.appendChild(td);
        });

        const subtotal=sumSubtotal(b);
        const tdSub=document.createElement("td"); tdSub.className="num"; tdSub.textContent=currency(subtotal); tr.appendChild(tdSub);

        const tdPaid=document.createElement("td"); tdPaid.className="num";
        const paidInput=document.createElement("input"); paidInput.type="number"; paidInput.step="0.01"; paidInput.value=b.paid||0; paidInput.style.width="90px"; paidInput.style.textAlign="right";
        paidInput.addEventListener("input", ()=>{ b.paid=parseFloat(paidInput.value)||0; saveState(); render(); });
        tdPaid.appendChild(paidInput); tr.appendChild(tdPaid);

        const tdBal=document.createElement("td"); tdBal.className="num"; tdBal.textContent=currency(subtotal-(b.paid||0)); tr.appendChild(tdBal);

        tbody.appendChild(tr);
      });

      while (tfootRow.children.length > 1) tfootRow.removeChild(tfootRow.lastChild);
      CATEGORIES.forEach(c=>{
        const totalCount = state.bowlers.reduce((a,b)=>a+(b.counts[c.key]||0),0);
        const td=document.createElement("td"); td.className="center"; td.textContent=totalCount; tfootRow.appendChild(td);
      });
      const teamSubtotal = state.bowlers.reduce((a,b)=>a+sumSubtotal(b),0);
      const teamPaid = state.bowlers.reduce((a,b)=>a+(b.paid||0),0);
      const teamBal = teamSubtotal - teamPaid;
      [teamSubtotal,teamPaid,teamBal].forEach(val=>{ const td=document.createElement("td"); td.className="num"; td.textContent=currency(val); tfootRow.appendChild(td); });

      renderArchiveList();
    }

    function buildCSV(night){
      const headers = ["Title","Bowler"].concat(CATEGORIES.map(c=>c.label + " (count)")).concat(CATEGORIES.map(c=>c.label + " ($)")).concat(["Subtotal ($)","Paid ($)","Balance ($)"]);
      const rows = night.bowlers.map(b=>{
        const counts = CATEGORIES.map(c=> String(b.counts[c.key]||0));
        const dollars = CATEGORIES.map(c=> ((b.counts[c.key]||0)*c.value).toFixed(2));
        const subtotal = sumSubtotal(b);
        const paid = b.paid||0; const balance = subtotal - paid;
        return [night.title, b.name].concat(counts).concat(dollars).concat([subtotal.toFixed(2), paid.toFixed(2), balance.toFixed(2)]);
      });
      return [headers].concat(rows).map(r => r.map(csvEscape).join(",")).join("\n");
    }

    function download(name, text, type){
      const blob = new Blob([text], { type: type || "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = name; a.click();
      URL.revokeObjectURL(url);
    }

    function saveNight(){
      const night = JSON.parse(JSON.stringify(state));
      const archive = loadArchive(); archive.unshift(night); saveArchive(archive);
      alert("Night saved to Archive.");
    }

    function renderArchiveList(){
      const archive = loadArchive();
      archiveList.innerHTML = "";
      if (archive.length === 0){ const p=document.createElement("p"); p.className="muted"; p.textContent="No saved nights yet."; archiveList.appendChild(p); return; }
      archive.forEach((night, idx) => {
        const details=document.createElement("details");
        const summary=document.createElement("summary"); summary.textContent = night.title || ("Night " + (idx+1)); details.appendChild(summary);
        const inner=document.createElement("div"); inner.style.margin="8px 0 12px 16px";

        const btnRow=document.createElement("div"); btnRow.className="row";
        const exp=document.createElement("button"); exp.textContent="Export CSV"; exp.addEventListener("click", function(){ download((night.title||("night_"+(idx+1)))+".csv", buildCSV(night), "text/csv;charset=utf-8;"); });
        const load=document.createElement("button"); load.textContent="Load into Live"; load.addEventListener("click", function(){ state = night; saveState(); render(); window.scrollTo({top:0,behavior:'smooth'}); });
        const del=document.createElement("button"); del.textContent="Delete"; del.className="btn-danger"; del.addEventListener("click", function(){ if(confirm("Delete this saved night?")){ const a=loadArchive(); a.splice(idx,1); saveArchive(a); renderArchiveList(); }});
        btnRow.appendChild(exp); btnRow.appendChild(load); btnRow.appendChild(del); inner.appendChild(btnRow);

        details.appendChild(inner); archiveList.appendChild(details);
      });
    }

    function renderTotals(){
      const includeLive = includeLiveChk.checked;
      const archive = loadArchive();
      const nights = archive.slice();
      if (includeLive) nights.unshift(state);

      // Aggregate per bowler
      const CKEYS = CATEGORIES.map(c=>c.key);
      const bowlerMap = {};
      function norm(s){ return String(s||"").trim().toLowerCase(); }
      nights.forEach(function(night){
        (night && night.bowlers || []).forEach(function(b){
          const key = norm(b.name);
          if (!bowlerMap[key]){
            const counts = {}; CKEYS.forEach(function(k){ counts[k]=0; });
            bowlerMap[key] = { name: b.name, counts: counts, subtotal:0, paid:0 };
          }
          const agg = bowlerMap[key];
          CKEYS.forEach(function(k){ agg.counts[k] += (b.counts && b.counts[k] || 0); });
          const sub = CATEGORIES.reduce(function(acc,c){ return acc + ((b.counts && b.counts[c.key] || 0) * c.value); }, 0);
          agg.subtotal += sub;
          agg.paid += (b.paid || 0);
        });
      });

      // Totals by bowler
      const wrap = document.getElementById("totalsByBowler");
      wrap.innerHTML = "";
      const t = document.createElement("table");
      const thead = document.createElement("thead");
      var hdrs = ["Bowler"].concat(CATEGORIES.map(function(c){return c.label+" (dots)";})).concat(CATEGORIES.map(function(c){return c.label+" ($)";})).concat(["Subtotal","Paid","Balance"]);
      hdrs.forEach(function(h){ var th=document.createElement("th"); th.textContent=h; thead.appendChild(th); });
      t.appendChild(thead);
      const tb = document.createElement("tbody");
      Object.values(bowlerMap).forEach(function(agg){
        const tr=document.createElement("tr");
        const tdn=document.createElement("td"); tdn.textContent=agg.name; tr.appendChild(tdn);
        CATEGORIES.forEach(function(c){ var td=document.createElement("td"); td.className="center"; td.textContent=agg.counts[c.key]; tr.appendChild(td); });
        CATEGORIES.forEach(function(c){ var td=document.createElement("td"); td.className="num"; td.textContent=currency(agg.counts[c.key]*c.value); tr.appendChild(td); });
        const bal = agg.subtotal - agg.paid;
        [agg.subtotal, agg.paid, bal].forEach(function(val){ var td=document.createElement("td"); td.className="num"; td.textContent=currency(val); tr.appendChild(td); });
        tb.appendChild(tr);
      });
      t.appendChild(tb);
      wrap.appendChild(t);

      // Team totals by category
      const catWrap = document.getElementById("totalsByCategory");
      catWrap.innerHTML = "";
      const t2 = document.createElement("table");
      const thead2 = document.createElement("thead");
      ["Category","Dots","Dollars"].forEach(function(h){ var th=document.createElement("th"); th.textContent=h; thead2.appendChild(th); });
      t2.appendChild(thead2);
      const tb2 = document.createElement("tbody");
      CATEGORIES.forEach(function(c){
        var dots = 0;
        nights.forEach(function(n){ (n && n.bowlers || []).forEach(function(b){ dots += (b.counts && b.counts[c.key] || 0); }); });
        var tr=document.createElement("tr");
        var td1=document.createElement("td"); td1.textContent=c.label; tr.appendChild(td1);
        var td2=document.createElement("td"); td2.className="center"; td2.textContent=dots; tr.appendChild(td2);
        var td3=document.createElement("td"); td3.className="num"; td3.textContent=currency(dots*c.value); tr.appendChild(td3);
        tb2.appendChild(tr);
      });
      t2.appendChild(tb2);
      catWrap.appendChild(t2);

      // Nights summary
      const nightWrap = document.getElementById("totalsByNight");
      nightWrap.innerHTML = "";
      const t3 = document.createElement("table");
      const thead3 = document.createElement("thead");
      ["Night","Team Dots ($)","Team Paid","Team Balance"].forEach(function(h){ var th=document.createElement("th"); th.textContent=h; thead3.appendChild(th); });
      t3.appendChild(thead3);
      const tb3 = document.createElement("tbody");
      nights.forEach(function(n){
        const teamSubtotal = (n && n.bowlers || []).reduce(function(a,b){ return a + CATEGORIES.reduce(function(acc,c){ return acc + ((b.counts && b.counts[c.key] || 0) * c.value); }, 0); }, 0);
        const teamPaid = (n && n.bowlers || []).reduce(function(a,b){ return a + (b.paid || 0); }, 0);
        var tr=document.createElement("tr");
        var td1=document.createElement("td"); td1.textContent=n.title || "Untitled"; tr.appendChild(td1);
        var td2=document.createElement("td"); td2.className="num"; td2.textContent=currency(teamSubtotal); tr.appendChild(td2);
        var td3=document.createElement("td"); td3.className="num"; td3.textContent=currency(teamPaid); tr.appendChild(td3);
        var td4=document.createElement("td"); td4.className="num"; td4.textContent=currency(teamSubtotal-teamPaid); tr.appendChild(td4);
        tb3.appendChild(tr);
      });
      t3.appendChild(tb3);
      nightWrap.appendChild(t3);
    }

    titleInput.addEventListener("input", ()=>{ state.title = titleInput.value; saveState(); });
    saveNightBtn.addEventListener("click", saveNight);
    exportBtn.addEventListener("click", ()=>download((state.title||"dots")+".csv", buildCSV(state), "text/csv;charset=utf-8;"));
    resetCountersBtn.addEventListener("click", ()=>{ if(!confirm("Reset all counters to 0?")) return; state.bowlers.forEach(b=>CATEGORIES.forEach(c=>b.counts[c.key]=0)); saveState(); render(); });
    resetAllBtn.addEventListener("click", ()=>{ if(!confirm("Reset names, counters, and payments?")) return; state = seedState(); saveState(); render(); });
    clearArchiveBtn.addEventListener("click", ()=>{ if(!confirm("Clear ENTIRE archive?")) return; localStorage.removeItem(ARCHIVE_KEY); renderArchiveList(); });
    exportAllBtn.addEventListener("click", ()=>{ const archive = loadArchive(); if (archive.length===0){ alert("No saved nights yet."); return; } const combined = archive.map(n=>buildCSV(n)).join("\n\n"); download("dots-archive.csv", combined, "text/csv;charset=utf-8;"); });

    render();

    if ("serviceWorker" in navigator){
      window.addEventListener("load", ()=>navigator.serviceWorker.register("./sw.js").catch(err=>console.warn("SW register failed", err)));
    }
    if (window.matchMedia("(display-mode: standalone)").matches) installHint.textContent="Installed";
    else { installHint.textContent = "Install: " + (/iphone|ipad|ipod/i.test(navigator.userAgent) ? "Share → Add to Home Screen" : "Menu (⋮) → Install App"); }
  }
})();
</script>
</body>
</html>
