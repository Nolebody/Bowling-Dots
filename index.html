<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bowling Dots — Tap Counter (PWA)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0a0a0a">
<style>
  :root { color-scheme: dark; }
  html, body { margin:0; padding:0; background:#0a0a0a; color:#e5e5e5; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
  h1 { font-size: 24px; margin: 0 0 4px 0; }
  .muted { color:#a3a3a3; font-size: 14px; }
  .toolbar { display:flex; flex-wrap: wrap; gap:8px; align-items:center; margin-top: 8px; }
  input[type="text"], input[type="number"] { background:#1a1a1a; border:1px solid #333; color:#e5e5e5; border-radius:10px; padding:8px 10px; }
  input[type="search"] { background:#111; border:1px solid #333; color:#e5e5e5; border-radius:10px; padding:6px 8px; }
  button { background:#1f2937; color:#e5e5e5; border:1px solid #334155; border-radius:10px; padding:8px 12px; cursor:pointer; }
  button:hover { background:#334155; }
  .btn-primary { background:#047857; border-color:#065f46; }
  .btn-primary:hover { background:#059669; }
  .btn-danger { border-color:#b91c1c; color:#fca5a5; }
  .card { background:#0f0f0f; border:1px solid #262626; border-radius:16px; padding:16px; margin-top:16px; }
  .grid { display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:8px; }
  .rate { display:flex; justify-content:space-between; align-items:center; background:#121212; border:1px solid #262626; border-radius:12px; padding:8px 10px; font-size:14px; }
  table { width:100%; border-collapse:collapse; min-width:980px; }
  th, td { padding:8px; border-top:1px solid #262626; vertical-align:top; }
  th { color:#cfcfcf; text-align:left; }
  .num { text-align:right; font-variant-numeric: tabular-nums; }
  .center { text-align:center; }
  .counter { display:flex; gap:8px; align-items:center; justify-content:center; }
  .counter button { width:32px; height:32px; border-radius:8px; }
  .counter .plus { background:#166534; }
  .counter .plus:hover { background:#22c55e; }
  .small { font-size:11px; color:#a3a3a3; text-align:center; margin-top:4px; }
  tfoot td { font-weight:600; }
  .nowrap { white-space: nowrap; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .spacer { flex: 1 1 auto; }
  .link { color:#93c5fd; cursor:pointer; }
  details summary { cursor: pointer; }
  @media (max-width: 1200px) { .container { padding: 16px; } }
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Bowling Dots — Tap Counter</h1>
      <div class="muted">5‑man team • plus/minus taps • offline PWA • Archive</div>
      <div class="toolbar">
        <input id="titleInput" type="text" size="28" />
        <button id="saveNightBtn" class="btn-primary">Save Night</button>
        <button id="exportBtn">Export This Night (CSV)</button>
        <button id="resetCountersBtn">Reset Counters</button>
        <button id="resetAllBtn" class="btn-danger">Reset All</button>
        <span class="spacer"></span>
        <span id="installHint" class="muted"></span>
      </div>
    </header>

    <section class="card">
      <div class="row">
        <h3 style="margin:0;">Category Rates</h3>
        <span class="spacer"></span>
        <small class="muted">Tap +/− to adjust counters. Enter Paid to see balances.</small>
      </div>
      <div id="rates" class="grid"></div>
    </section>

    <section class="card" style="overflow:auto;">
      <div>
        <table id="table">
          <thead>
            <tr id="tableHeader">
              <th>Bowler</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
          <tfoot>
            <tr id="tableFooter">
              <td>Team Total</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <section class="card">
      <div class="row">
        <h3 style="margin:0;">Archive</h3>
        <span class="spacer"></span>
        <button id="exportAllBtn">Export All (CSV)</button>
        <button id="clearArchiveBtn" class="btn-danger">Clear Archive</button>
      </div>
      <div id="archiveList" style="margin-top:8px;"></div>
    </section>

    <section style="font-size:12px; color:#a3a3a3; margin-top:8px;">
      <p>• Install as a PWA: open this page, **Add to Home Screen**. On iPhone (Safari): Share → Add to Home Screen. On Android (Chrome): Menu (⋮) → Install App.</p>
      <p>• Works offline after the first load. If the bowling alley Wi‑Fi is spotty, you’re covered.</p>
    </section>
  </div>

<script>
(function() {
  // --- Config ---
  const DEFAULT_BOWLERS = ["Beau", "Doug", "Gerod", "Chris", "Logan"];
  const CATEGORIES = [
    { key: "missedSpare", label: "Missed Spare", value: 0.10 },
    { key: "missedHeadpin", label: "Missed Headpin", value: 0.10 },
    { key: "coke", label: "Coke (all but you strike)", value: 0.50 },
    { key: "threeInARow", label: "3 in a Row (Turkey)", value: 0.10 },
    { key: "reverseCoke", label: "Reverse Coke (only you strike)", value: 0.25 },
    { key: "buddy", label: "Buddy (prevent Coke)", value: 0.25 },
    { key: "average", label: "Average (didn’t beat avg)", value: 1.00 },
    { key: "loss", label: "Loss (H2H)", value: 1.00 },
  ];
  const STORAGE_KEY = "dotsSession_pwa_v1";
  const ARCHIVE_KEY = "dotsArchive_v1";

  function currency(n) { return "$" + n.toFixed(2); }

  // --- State ---
  let state = loadState() || seedState();

  function seedState() {
    const d = new Date();
    const title = `Dots — ${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    return {
      title,
      bowlers: DEFAULT_BOWLERS.map(n => ({
        name: n,
        counts: Object.fromEntries(CATEGORIES.map(c => [c.key, 0])),
        paid: 0,
      }))
    };
  }

  function loadState() { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){ return null; } }
  function saveState() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){} }

  function loadArchive() { try { return JSON.parse(localStorage.getItem(ARCHIVE_KEY)) || []; } catch(e){ return []; } }
  function saveArchive(arr) { try { localStorage.setItem(ARCHIVE_KEY, JSON.stringify(arr)); } catch(e){} }

  // --- DOM refs ---
  const titleInput = document.getElementById("titleInput");
  const ratesEl = document.getElementById("rates");
  const theadRow = document.getElementById("tableHeader");
  const tbody = document.getElementById("tableBody");
  const tfootRow = document.getElementById("tableFooter");
  const exportBtn = document.getElementById("exportBtn");
  const resetCountersBtn = document.getElementById("resetCountersBtn");
  const resetAllBtn = document.getElementById("resetAllBtn");
  const saveNightBtn = document.getElementById("saveNightBtn");
  const archiveList = document.getElementById("archiveList");
  const clearArchiveBtn = document.getElementById("clearArchiveBtn");
  const exportAllBtn = document.getElementById("exportAllBtn");
  const installHint = document.getElementById("installHint");

  // --- Render live night ---
  function render() {
    titleInput.value = state.title;

    // Rates
    ratesEl.innerHTML = "";
    CATEGORIES.forEach(c => {
      const div = document.createElement("div");
      div.className = "rate";
      const left = document.createElement("span"); left.textContent = c.label;
      const right = document.createElement("span"); right.textContent = currency(c.value);
      div.appendChild(left); div.appendChild(right);
      ratesEl.appendChild(div);
    });

    // Header
    theadRow.innerHTML = "<th>Bowler</th>";
    CATEGORIES.forEach(c => {
      const th = document.createElement("th");
      th.textContent = c.label;
      th.className = "center nowrap";
      theadRow.appendChild(th);
    });
    ["Subtotal", "Paid", "Balance"].forEach(txt => {
      const th = document.createElement("th");
      th.textContent = txt; th.className = "num";
      theadRow.appendChild(th);
    });

    // Body
    tbody.innerHTML = "";
    state.bowlers.forEach((b, i) => {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      const nameInput = document.createElement("input");
      nameInput.type = "text"; nameInput.value = b.name; nameInput.size = 14;
      nameInput.addEventListener("input", () => { b.name = nameInput.value; saveState(); });
      tdName.appendChild(nameInput); tr.appendChild(tdName);

      CATEGORIES.forEach(c => {
        const td = document.createElement("td");
        const box = document.createElement("div");
        box.className = "counter";

        const minus = document.createElement("button");
        minus.textContent = "−";
        minus.addEventListener("click", () => { b.counts[c.key] = Math.max(0, (b.counts[c.key]||0) - 1); saveState(); render(); });

        const count = document.createElement("div");
        count.textContent = b.counts[c.key] || 0;
        count.style.width = "40px"; count.style.textAlign = "center"; count.style.fontVariantNumeric = "tabular-nums";

        const plus = document.createElement("button");
        plus.textContent = "+"; plus.className = "plus";
        plus.addEventListener("click", () => { b.counts[c.key] = (b.counts[c.key]||0) + 1; saveState(); render(); });

        box.appendChild(minus); box.appendChild(count); box.appendChild(plus);
        td.appendChild(box);

        const small = document.createElement("div");
        small.className = "small";
        small.textContent = currency((b.counts[c.key] || 0) * c.value);
        td.appendChild(small);

        tr.appendChild(td);
      });

      const subtotal = sumSubtotal(b);
      const tdSub = document.createElement("td"); tdSub.className = "num"; tdSub.textContent = currency(subtotal); tr.appendChild(tdSub);

      const tdPaid = document.createElement("td");
      tdPaid.className = "num";
      const paidInput = document.createElement("input");
      paidInput.type = "number"; paidInput.step = "0.01"; paidInput.value = b.paid || 0;
      paidInput.style.width = "90px"; paidInput.style.textAlign = "right";
      paidInput.addEventListener("input", () => { b.paid = parseFloat(paidInput.value) || 0; saveState(); render(); });
      tdPaid.appendChild(paidInput);
      tr.appendChild(tdPaid);

      const tdBal = document.createElement("td"); tdBal.className = "num"; tdBal.textContent = currency(subtotal - (b.paid || 0)); tr.appendChild(tdBal);

      tbody.appendChild(tr);
    });

    // Footer totals
    tfootRow.innerHTML = "<td>Team Total</td>";
    CATEGORIES.forEach(c => {
      const totalCount = state.bowlers.reduce((a, b) => a + (b.counts[c.key] || 0), 0);
      const td = document.createElement("td");
      td.className = "center"; td.textContent = totalCount;
      tfootRow.appendChild(td);
    });
    const teamSubtotal = state.bowlers.reduce((a,b) => a + sumSubtotal(b), 0);
    const teamPaid = state.bowlers.reduce((a,b) => a + (b.paid || 0), 0);
    const teamBal = teamSubtotal - teamPaid;
    [teamSubtotal, teamPaid, teamBal].forEach(val => {
      const td = document.createElement("td"); td.className="num"; td.textContent = currency(val); tfootRow.appendChild(td);
    });

    renderArchiveList();
  }

  function sumSubtotal(b) { return CATEGORIES.reduce((acc, c) => acc + (b.counts[c.key] || 0) * c.value, 0); }

  // --- Export helpers ---
  function buildCSV(night) {
    const headers = [
      "Title","Bowler",
      ...CATEGORIES.map(c => `${c.label} (count)`),
      ...CATEGORIES.map(c => `${c.label} ($)`),
      "Subtotal ($)","Paid ($)","Balance ($)"
    ];
    const rows = night.bowlers.map(b => {
      const counts = CATEGORIES.map(c => String(b.counts[c.key] || 0));
      const dollars = CATEGORIES.map(c => ((b.counts[c.key] || 0) * c.value).toFixed(2));
      const subtotal = sumSubtotal(b);
      const paid = b.paid || 0;
      const balance = subtotal - paid;
      return [night.title, b.name, ...counts, ...dollars, subtotal.toFixed(2), paid.toFixed(2), balance.toFixed(2)];
    });
    return [headers, ...rows].map(r => r.map(cell => `"${String(cell).replaceAll('"','""')}"`).join(",")).join("\n");
  }

  function download(name, text, type="text/plain") {
    const blob = new Blob([text], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name; a.click();
    URL.revokeObjectURL(url);
  }

  // --- Archive ---
  function saveNight() {
    const night = JSON.parse(JSON.stringify(state));
    const archive = loadArchive();
    archive.unshift(night); // newest first
    saveArchive(archive);
    alert("Night saved to Archive.");
  }

  function renderArchiveList() {
    const archive = loadArchive();
    archiveList.innerHTML = "";
    if (archive.length === 0) {
      const p = document.createElement("p");
      p.className = "muted"; p.textContent = "No saved nights yet.";
      archiveList.appendChild(p);
      return;
    }
    archive.forEach((night, idx) => {
      const details = document.createElement("details");
      const summary = document.createElement("summary");
      summary.textContent = `${night.title}`;
      details.appendChild(summary);

      const inner = document.createElement("div"); inner.style.margin = "8px 0 12px 16px";

      const btnRow = document.createElement("div"); btnRow.className = "row";
      const expThis = document.createElement("button"); expThis.textContent = "Export CSV"; expThis.addEventListener("click", () => download((night.title||`night_${idx+1}`)+".csv", buildCSV(night), "text/csv;charset=utf-8;"));
      const restore = document.createElement("button"); restore.textContent = "Load into Live"; restore.addEventListener("click", () => { state = night; saveState(); render(); window.scrollTo({top:0, behavior:'smooth'}); });
      const del = document.createElement("button"); del.textContent = "Delete"; del.className="btn-danger"; del.addEventListener("click", () => { if(confirm("Delete this saved night?")) { const a = loadArchive(); a.splice(idx,1); saveArchive(a); renderArchiveList(); } });
      btnRow.appendChild(expThis); btnRow.appendChild(restore); btnRow.appendChild(del);
      inner.appendChild(btnRow);

      const table = document.createElement("table");
      table.style.marginTop = "8px";
      const thead = document.createElement("thead");
      const hr = document.createElement("tr");
      ["Bowler", ...CATEGORIES.map(c=>c.label), "Subtotal", "Paid", "Balance"].forEach(h=>{ const th = document.createElement("th"); th.textContent=h; thead.appendChild(th); });
      table.appendChild(thead);
      const tb = document.createElement("tbody");
      night.bowlers.forEach(b=>{
        const tr = document.createElement("tr");
        const tdn = document.createElement("td"); tdn.textContent = b.name; tr.appendChild(tdn);
        CATEGORIES.forEach(c=>{ const td = document.createElement("td"); td.className="center"; td.textContent = b.counts[c.key]||0; tr.appendChild(td); });
        const subtotal = CATEGORIES.reduce((acc,c)=> acc + (b.counts[c.key]||0)*c.value, 0);
        const tdS = document.createElement("td"); tdS.className="num"; tdS.textContent = currency(subtotal); tr.appendChild(tdS);
        const tdP = document.createElement("td"); tdP.className="num"; tdP.textContent = currency(b.paid||0); tr.appendChild(tdP);
        const tdB = document.createElement("td"); tdB.className="num"; tdB.textContent = currency(subtotal-(b.paid||0)); tr.appendChild(tdB);
        tb.appendChild(tr);
      });
      table.appendChild(tb);
      inner.appendChild(table);

      details.appendChild(inner);
      archiveList.appendChild(details);
    });
  }

  // --- Events ---
  titleInput.addEventListener("input", () => { state.title = titleInput.value; saveState(); });
  document.getElementById("saveNightBtn").addEventListener("click", saveNight);
  exportBtn.addEventListener("click", () => download((state.title||"dots")+".csv", buildCSV(state), "text/csv;charset=utf-8;"));
  document.getElementById("resetCountersBtn").addEventListener("click", () => { if(!confirm("Reset all counters to 0?")) return; state.bowlers.forEach(b=>CATEGORIES.forEach(c=>b.counts[c.key]=0)); saveState(); render(); });
  document.getElementById("resetAllBtn").addEventListener("click", () => { if(!confirm("Reset names, counters, and payments?")) return; state = seedState(); saveState(); render(); });
  document.getElementById("clearArchiveBtn").addEventListener("click", () => { if(!confirm("Clear ENTIRE archive?")) return; localStorage.removeItem(ARCHIVE_KEY); renderArchiveList(); });
  document.getElementById("exportAllBtn").addEventListener("click", () => {
    const archive = loadArchive();
    if (archive.length === 0) { alert("No saved nights yet."); return; }
    const combined = archive.map(n => buildCSV(n)).join("\\n\\n");
    download("dots-archive.csv", combined, "text/csv;charset=utf-8;");
  });

  // --- Initial render ---
  render();

  // --- PWA ---
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }

  // Install hint
  if (window.matchMedia("(display-mode: standalone)").matches) {
    document.getElementById("installHint").textContent = "Installed";
  } else {
    const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    const msg = isIOS ? "Share → Add to Home Screen" : "Menu (⋮) → Install App";
    document.getElementById("installHint").textContent = "Install: " + msg;
  }
})();
</script>
</body>
</html>
